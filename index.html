<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yoklama Sistemi</title>
<style>
  body { font-family: Arial,sans-serif; text-align:center; margin-top:50px; }
  input, button { padding:10px; margin-top:10px; width:250px; }
  #status { margin-top:15px; font-weight:bold; }
  #registerForm { display:none; }
</style>
</head>
<body>
<h1>Yoklama Sistemi</h1>

<form id="registerForm">
  <input type="text" id="name" placeholder="Ad Soyad" required><br>
  <input type="email" id="email" placeholder="E-posta" required><br>
  <input type="text" id="phone" placeholder="Telefon" required><br>
  <button type="submit">Kaydet ve Yoklamayı Al</button>
</form>

<p id="status">Kontrol ediliyor...</p>

<script>
const API_URL = "https://yoklama-peach.vercel.app/api/yoklama";

function getUUID() {
  let uuid = localStorage.getItem("device_uuid");
  if (!uuid) {
    uuid = (crypto.randomUUID) ? crypto.randomUUID() :
      'xxxx-xxxx-4xxx-yxxx-xxxx'.replace(/[xy]/g,function(c){
        var r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16);
      });
    localStorage.setItem("device_uuid", uuid);
  }
  return uuid;
}

async function sendAttendance(data) {
  const statusEl = document.getElementById('status');
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(data)
    });
    
    // JSON parse ediyoruz
    const json = await res.json();
    statusEl.innerText = json.message || "Yoklama kaydı alındı ✅";

  } catch(err) {
    console.error(err);
    statusEl.innerText = "Hata oluştu ❌";
  }
}


window.onload = () => {
  const uuid = getUUID();
  const form = document.getElementById('registerForm');

  // Eğer UUID yeni ise formu göster
  if (!localStorage.getItem("hasRegistered")) {
    form.style.display = "block";
    document.getElementById('status').innerText = "Lütfen kayıt olun";
  } else {
    // Daha önce kayıt olmuşsa direkt yoklama gönder
    sendAttendance({uuid});
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('name').value.trim();
    const email = document.getElementById('email').value.trim();
    const phone = document.getElementById('phone').value.trim();

    await sendAttendance({uuid, name, email, phone});
    localStorage.setItem("hasRegistered", "true");
    form.style.display = "none";
  });
};
</script>
</body>
</html>

